<!-- REDESIGNED: iOS-Inspired Data Source Section -->
<!-- Replace lines 187-222 in index.html -->

<!-- Data Source Status (Minimal, Calm) -->
<div class="data-source-status">
    <div class="status-row">
        <span class="status-label">Data Source</span>
        <div class="status-value">
            <span class="status-indicator" id="dataSourceIndicator"></span>
            <span id="dataSourceProvider">Simulated</span>
        </div>
    </div>
    <div class="status-row secondary">
        <span class="status-label">Last Updated</span>
        <span class="status-value" id="lastDataUpdate">â€”</span>
    </div>
    <button class="status-action-btn" onclick="openDataSourceSettings()">
        <i class="fas fa-gear"></i>
        <span>Configure</span>
    </button>
</div>

<!-- Data Source Settings Modal (Hidden by default) -->
<div id="dataSourceModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeDataSourceSettings()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Data Source</h2>
            <button class="modal-close" onclick="closeDataSourceSettings()">
                <i class="fas fa-xmark"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Provider Selection -->
            <div class="settings-section">
                <label class="settings-label">Provider</label>
                <select id="apiProvider" class="settings-select">
                    <option value="yahoo">Yahoo Finance</option>
                    <option value="tradier">Tradier Sandbox</option>
                    <option value="tdameritrade">TD Ameritrade</option>
                    <option value="polygon">Massive.com</option>
                </select>
                <p class="settings-hint" id="providerHint">Free, 15-minute delayed data</p>
            </div>
            
            <!-- API Key Input (Only shown for providers that need it) -->
            <div class="settings-section" id="apiKeySection" style="display: none;">
                <label class="settings-label">API Key</label>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    class="settings-input"
                    placeholder="Enter your API key"
                />
                <p class="settings-hint">
                    <a href="#" id="providerLink" target="_blank">Get API key</a>
                </p>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeDataSourceSettings()">Cancel</button>
            <button class="btn-primary" onclick="saveDataSourceSettings()">Save</button>
        </div>
    </div>
</div>

<style>
/* iOS-Inspired Data Source Status */
.data-source-status {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-6);
}

.status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) 0;
}

.status-row.secondary {
    border-top: 1px solid var(--separator);
    margin-top: var(--space-2);
    padding-top: var(--space-3);
}

.status-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    font-weight: var(--weight-medium);
}

.status-value {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--text-primary);
    font-weight: var(--weight-medium);
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--status-neutral);
}

.status-indicator.connected {
    background: var(--status-success);
}

.status-indicator.error {
    background: var(--status-error);
}

.status-action-btn {
    margin-top: var(--space-4);
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--bg-tertiary);
    border: none;
    border-radius: var(--radius-md);
    color: var(--accent-primary);
    font-size: var(--text-sm);
    font-weight: var(--weight-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--easing);
}

.status-action-btn:hover {
    background: var(--bg-elevated);
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
}

.modal-content {
    position: relative;
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 480px;
    box-shadow: var(--elevation-4);
    animation: modalSlideUp 0.25s var(--easing);
}

@keyframes modalSlideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-5);
    border-bottom: 1px solid var(--separator);
}

.modal-header h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    color: var(--text-primary);
    margin: 0;
}

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border: none;
    border-radius: 50%;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--duration-fast) var(--easing);
}

.modal-close:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.modal-body {
    padding: var(--space-5);
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-5);
    border-top: 1px solid var(--separator);
}

.modal-footer button {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: var(--weight-medium);
    cursor: pointer;
    transition: all var(--duration-fast) var(--easing);
}

.btn-secondary {
    background: var(--bg-tertiary);
    border: none;
    color: var(--text-primary);
}

.btn-secondary:hover {
    background: var(--bg-elevated);
}

.btn-primary {
    background: var(--accent-primary);
    border: none;
    color: #ffffff;
}

.btn-primary:hover {
    background: var(--accent-primary-hover);
}

/* Settings Section */
.settings-section {
    margin-bottom: var(--space-5);
}

.settings-section:last-child {
    margin-bottom: 0;
}

.settings-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--weight-medium);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
}

.settings-select,
.settings-input {
    width: 100%;
    padding: var(--space-3);
    background: var(--bg-secondary);
    border: 1px solid var(--separator);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--text-base);
    font-family: inherit;
    transition: all var(--duration-fast) var(--easing);
}

.settings-select:focus,
.settings-input:focus {
    outline: none;
    border-color: var(--accent-primary);
    background: var(--bg-tertiary);
}

.settings-hint {
    margin-top: var(--space-2);
    font-size: var(--text-xs);
    color: var(--text-tertiary);
}

.settings-hint a {
    color: var(--accent-primary);
    text-decoration: none;
}

.settings-hint a:hover {
    text-decoration: underline;
}
</style>

<script>
// Data Source Settings Functions
function openDataSourceSettings() {
    document.getElementById('dataSourceModal').style.display = 'flex';
    
    // Update provider hints
    const providerSelect = document.getElementById('apiProvider');
    updateProviderHints(providerSelect.value);
    
    providerSelect.addEventListener('change', function() {
        updateProviderHints(this.value);
    });
}

function closeDataSourceSettings() {
    document.getElementById('dataSourceModal').style.display = 'none';
}

function updateProviderHints(provider) {
    const apiKeySection = document.getElementById('apiKeySection');
    const providerHint = document.getElementById('providerHint');
    const providerLink = document.getElementById('providerLink');
    
    const hints = {
        yahoo: {
            text: 'Free, 15-minute delayed data. No API key required.',
            showKey: false
        },
        tradier: {
            text: 'Free sandbox with real-time quotes',
            showKey: true,
            link: 'https://tradier.com'
        },
        tdameritrade: {
            text: 'Free with brokerage account',
            showKey: true,
            link: 'https://developer.tdameritrade.com'
        },
        polygon: {
            text: 'Paid plans starting at $29/mo',
            showKey: true,
            link: 'https://massive.com'
        }
    };
    
    const config = hints[provider];
    providerHint.textContent = config.text;
    
    if (config.showKey) {
        apiKeySection.style.display = 'block';
        providerLink.href = config.link;
    } else {
        apiKeySection.style.display = 'none';
    }
}

function saveDataSourceSettings() {
    const provider = document.getElementById('apiProvider').value;
    const apiKey = document.getElementById('apiKeyInput').value;
    
    // Call existing configureAPI function with provider and key
    if (provider === 'yahoo' || apiKey.trim()) {
        configureAPI(provider, apiKey);
        closeDataSourceSettings();
        
        // Update status display
        updateDataSourceStatus(provider);
    } else {
        alert('Please enter an API key');
    }
}

function updateDataSourceStatus(provider) {
    const indicator = document.getElementById('dataSourceIndicator');
    const providerText = document.getElementById('dataSourceProvider');
    const lastUpdate = document.getElementById('lastDataUpdate');
    
    const names = {
        yahoo: 'Yahoo Finance',
        tradier: 'Tradier',
        tdameritrade: 'TD Ameritrade',
        polygon: 'Massive.com'
    };
    
    indicator.className = 'status-indicator connected';
    providerText.textContent = names[provider] || 'Simulated';
    lastUpdate.textContent = 'Just now';
    
    // Update every minute
    setInterval(() => {
        const now = new Date();
        const minutes = now.getMinutes();
        lastUpdate.textContent = minutes === 0 ? 'Just now' : `${minutes} min ago`;
    }, 60000);
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDataSourceSettings();
    }
});
</script>
