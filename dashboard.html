<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard - Options Intelligence Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: #111;
            padding: 20px;
            border-bottom: 1px solid #222;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
        }
        
        .nav {
            display: flex;
            gap: 20px;
        }
        
        .nav-link {
            color: #888;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .nav-link:hover, .nav-link.active {
            color: #fff;
            background: #222;
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #111;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #222;
        }
        
        .stat-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #00ff88;
        }
        
        .stat-value.negative {
            color: #ff4444;
        }
        
        /* Sections */
        .section {
            background: #111;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #222;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }
        
        .section-subtitle {
            color: #888;
            font-size: 14px;
            margin-top: 4px;
        }
        
        /* Buttons */
        .btn {
            background: #00ff88;
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #00dd77;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #222;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: #333;
        }
        
        /* Signal Cards */
        .signals-grid {
            display: grid;
            gap: 20px;
        }
        
        .signal-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            border-left: 4px solid #00ff88;
            transition: all 0.2s;
        }
        
        .signal-card:hover {
            background: #222;
            transform: translateY(-2px);
        }
        
        .signal-card.sell-signal {
            border-left-color: #ff4444;
        }
        
        .signal-card.buy-signal {
            border-left-color: #00aaff;
        }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .signal-symbol {
            font-size: 24px;
            font-weight: 700;
        }
        
        .signal-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .signal-badge.sell {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .signal-badge.buy {
            background: rgba(0, 170, 255, 0.2);
            color: #00aaff;
        }
        
        .signal-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .signal-detail {
            display: flex;
            flex-direction: column;
        }
        
        .signal-detail-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .signal-detail-value {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        
        .signal-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        /* Position Table */
        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .positions-table thead {
            background: #1a1a1a;
        }
        
        .positions-table th {
            padding: 12px;
            text-align: left;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .positions-table td {
            padding: 16px 12px;
            border-top: 1px solid #222;
        }
        
        .positions-table tr:hover {
            background: #1a1a1a;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.open {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .status-badge.closed {
            background: rgba(136, 136, 136, 0.2);
            color: #888;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #888;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .signal-details {
                grid-template-columns: 1fr;
            }
            
            .positions-table {
                font-size: 14px;
            }
            
            .positions-table th,
            .positions-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">üìä Options Intelligence</div>
            <nav class="nav">
                <a href="#" class="nav-link active" onclick="showTab('dashboard'); return false;">Dashboard</a>
                <a href="#" class="nav-link" onclick="showTab('signals'); return false;">Signals</a>
                <a href="#" class="nav-link" onclick="showTab('positions'); return false;">Positions</a>
                <a href="backtest.html" class="nav-link">Backtest</a>
                <a href="index.html" class="nav-link">Analysis</a>
            </nav>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Open Positions</div>
                <div class="stat-value" id="statOpenPositions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value" id="statWinRate">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total P&L</div>
                <div class="stat-value" id="statTotalPnL">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Signals</div>
                <div class="stat-value" id="statActiveSignals">0</div>
            </div>
        </div>

        <!-- Today's Opportunities Section -->
        <div class="section" id="signalsSection">
            <div class="section-header">
                <div>
                    <div class="section-title">üéØ Today's Opportunities</div>
                    <div class="section-subtitle">High-probability setups based on IV Rank analysis</div>
                </div>
                <button class="btn" onclick="scanMarket()" id="scanBtn">
                    Scan Market
                </button>
            </div>
            
            <div id="signalsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <div class="empty-state-title">No signals yet</div>
                    <div>Click "Scan Market" to find opportunities</div>
                </div>
            </div>
        </div>

        <!-- Active Positions Section -->
        <div class="section" id="positionsSection">
            <div class="section-header">
                <div>
                    <div class="section-title">üìà Active Positions</div>
                    <div class="section-subtitle">Monitor your open trades</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn" onclick="manualEntry()">
                        + Add Position
                    </button>
                    <button class="btn-secondary btn" onclick="refreshPositions()">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div id="positionsContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-title">No open positions</div>
                    <div>Add positions from signals or manually</div>
                </div>
            </div>
        </div>

        <!-- Trade History Section -->
        <div class="section" id="historySection">
            <div class="section-header">
                <div>
                    <div class="section-title">üìã Trade History</div>
                    <div class="section-subtitle">Past closed positions</div>
                </div>
                <button class="btn-secondary btn" onclick="PositionManager.exportPositions()">
                    Export
                </button>
            </div>
            
            <div id="historyContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <div class="empty-state-title">No trade history</div>
                    <div>Closed positions will appear here</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="js/expanded-stocks.js"></script>
    <script src="js/realtime-data.js"></script>
    <script src="js/data.js"></script>
    <script src="js/calculations.js"></script>
    <script src="js/massive-historical-data-v2026.js"></script>
    <script src="js/iv-rank-engine.js"></script>
    <script src="js/backtest-engine.js"></script>
    
    <!-- üöÄ NEW: WebSocket Client for Real-Time Data -->
    <script src="js/massive-websocket.js"></script>
    
    <!-- ‚úÖ CACHE-BUSTED VERSION (v2026e) - Fixes Current IV display -->
    <script src="js/signal-scanner-v2026e.js"></script>
    <script src="js/position-manager.js"></script>

    <script>
        // üöÄ WebSocket connection for real-time data
        let massiveWS = null;

        async function initializeWebSocket() {
            try {
                console.log('üîå Initializing Massive WebSocket...');
                
                // Get API key from RealTimeData
                const apiKey = RealTimeData.apis.polygon.apiKey;
                
                if (!apiKey || apiKey === 'YOUR_NEW_API_KEY_HERE') {
                    console.warn('‚ö†Ô∏è No API key configured, WebSocket disabled');
                    return;
                }
                
                // Create WebSocket client
                massiveWS = new MassiveWebSocket(apiKey);
                
                // Connect and authenticate
                await massiveWS.connect();
                
                // Subscribe to watchlist
                const watchlist = SignalScanner.watchlist;
                massiveWS.subscribe(watchlist);
                
                console.log('‚úÖ Massive WebSocket ready!');
                console.log(`üì° Subscribed to ${watchlist.length} stocks for real-time updates`);
                
                // Optional: Set up price update handler
                massiveWS.onPriceUpdate = (priceData) => {
                    // console.log(`üìä Price update: ${priceData.symbol} = $${priceData.price.toFixed(2)}`);
                    // Could trigger UI updates here in the future
                };
                
            } catch (error) {
                console.error('‚ùå WebSocket initialization failed:', error);
                console.log('‚ö†Ô∏è Falling back to REST API for data');
                massiveWS = null; // Ensure it's null so we fall back to REST
            }
        }

        // Initialize dashboard on load
        window.addEventListener('load', async () => {
            console.log('üöÄ Trading Dashboard loaded');
            updateStats();
            refreshPositions();
            
            // Initialize WebSocket for real-time data
            await initializeWebSocket();
        });

        // Tab navigation
        function showTab(tabName) {
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide sections (implement if needed)
            console.log(`Switched to ${tabName} tab`);
        }

        // Scan market for opportunities
        async function scanMarket() {
            const btn = document.getElementById('scanBtn');
            const container = document.getElementById('signalsContainer');
            
            btn.disabled = true;
            btn.textContent = 'Scanning...';
            
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Scanning ${SignalScanner.watchlist.length} stocks for opportunities...</div>
                </div>
            `;
            
            try {
                const signals = await SignalScanner.scanAll();
                displaySignals(signals);
                updateStats();
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <div class="empty-state-title">Scan Error</div>
                        <div>${error.message}</div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Scan Market';
            }
        }

        // Display signals
        function displaySignals(signals) {
            const container = document.getElementById('signalsContainer');
            
            if (signals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <div class="empty-state-title">No opportunities found</div>
                        <div>Market conditions don't meet IV Rank criteria</div>
                    </div>
                `;
                return;
            }
            
            const html = signals.map(signal => `
                <div class="signal-card ${signal.action.toLowerCase()}-signal">
                    <div class="signal-header">
                        <div class="signal-symbol">${signal.symbol}</div>
                        <div class="signal-badge ${signal.action.toLowerCase()}">
                            ${signal.action}
                        </div>
                    </div>
                    
                    <div class="signal-details">
                        <div class="signal-detail">
                            <div class="signal-detail-label">Strategy</div>
                            <div class="signal-detail-value">${signal.strategy}</div>
                        </div>
                        <div class="signal-detail">
                            <div class="signal-detail-label">IV Rank</div>
                            <div class="signal-detail-value">${signal.ivRank.toFixed(1)}%</div>
                        </div>
                        <div class="signal-detail">
                            <div class="signal-detail-label">Current IV</div>
                            <div class="signal-detail-value">${(signal.currentIV > 100 ? signal.currentIV / 100 : signal.currentIV).toFixed(1)}%</div>
                        </div>
                        <div class="signal-detail">
                            <div class="signal-detail-label">Confidence</div>
                            <div class="signal-detail-value">${signal.confidence}%</div>
                        </div>
                        <div class="signal-detail">
                            <div class="signal-detail-label">Backtest Win Rate</div>
                            <div class="signal-detail-value">${signal.backtest ? signal.backtest.winRate.toFixed(1) + '%' : 'N/A'}</div>
                        </div>
                        <div class="signal-detail">
                            <div class="signal-detail-label">Current Price</div>
                            <div class="signal-detail-value">$${signal.currentPrice.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="signal-actions">
                        <button class="btn" onclick='openPosition(${JSON.stringify(signal)})'>
                            Enter Trade
                        </button>
                        <button class="btn-secondary btn" onclick='viewDetails(${JSON.stringify(signal)})'>
                            View Details
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Open new position from signal
        function openPosition(signal) {
            const capital = prompt('Enter capital for this trade ($):', '1000');
            if (!capital) return;
            
            try {
                const position = {
                    symbol: signal.symbol,
                    action: signal.action,
                    strategy: signal.strategy,
                    entryPrice: signal.currentPrice,
                    entryIV: signal.currentIV,
                    entryIVRank: signal.ivRank,
                    capital: parseFloat(capital),
                    confidence: signal.confidence,
                    targetProfit: 0.50,
                    maxHoldDays: 21
                };
                
                PositionManager.addPosition(position);
                refreshPositions();
                updateStats();
                
                alert(`‚úÖ Position opened: ${signal.symbol} ${signal.strategy}`);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Manual position entry
        function manualEntry() {
            const symbol = prompt('Enter stock symbol (e.g., AAPL, SPY):', 'AAPL');
            if (!symbol) return;
            
            const action = prompt('Enter action (SELL or BUY):', 'SELL');
            if (!action || !['SELL', 'BUY'].includes(action.toUpperCase())) {
                alert('‚ùå Action must be SELL or BUY');
                return;
            }
            
            const strategy = prompt('Enter strategy (e.g., Iron Condor, Credit Spread):', 'Iron Condor');
            if (!strategy) return;
            
            const entryPrice = prompt('Enter stock price at entry:', '225');
            if (!entryPrice) return;
            
            const entryIV = prompt('Enter IV at entry (%):', '35');
            if (!entryIV) return;
            
            const entryIVRank = prompt('Enter IV Rank at entry (%):', '85');
            if (!entryIVRank) return;
            
            const capital = prompt('Enter capital for this trade ($):', '1000');
            if (!capital) return;
            
            try {
                const position = {
                    symbol: symbol.toUpperCase(),
                    action: action.toUpperCase(),
                    strategy: strategy,
                    entryPrice: parseFloat(entryPrice),
                    entryIV: parseFloat(entryIV),
                    entryIVRank: parseFloat(entryIVRank),
                    capital: parseFloat(capital),
                    confidence: 85,
                    targetProfit: 0.50,
                    maxHoldDays: 21
                };
                
                PositionManager.addPosition(position);
                refreshPositions();
                updateStats();
                
                alert(`‚úÖ Position opened: ${position.symbol} ${position.strategy}\nCapital: $${position.capital}\nEntry Price: $${position.entryPrice}`);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Refresh positions display
        function refreshPositions() {
            const openPositions = PositionManager.getOpenPositions();
            const closedPositions = PositionManager.getClosedPositions();
            
            displayPositions(openPositions, 'positionsContainer');
            displayPositions(closedPositions, 'historyContainer', true);
        }

        // Display positions in table
        function displayPositions(positions, containerId, isClosed = false) {
            const container = document.getElementById(containerId);
            
            if (positions.length === 0) {
                const message = isClosed ? 'No trade history' : 'No open positions';
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">${isClosed ? 'üìù' : 'üìä'}</div>
                        <div class="empty-state-title">${message}</div>
                    </div>
                `;
                return;
            }
            
            const html = `
                <table class="positions-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Strategy</th>
                            <th>Entry Date</th>
                            <th>Days Held</th>
                            <th>Capital</th>
                            <th>${isClosed ? 'P&L' : 'Current P&L'}</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${positions.map(pos => {
                            const daysHeld = PositionManager.getDaysHeld(pos);
                            const pnl = isClosed ? pos.finalPnL : PositionManager.calculatePnL(pos, pos.entryPrice * 1.02, daysHeld);
                            
                            return `
                                <tr>
                                    <td><strong>${pos.symbol}</strong></td>
                                    <td>${pos.strategy}</td>
                                    <td>${new Date(pos.entryDate).toLocaleDateString()}</td>
                                    <td>${daysHeld} days</td>
                                    <td>$${pos.capital.toFixed(0)}</td>
                                    <td style="color: ${pnl >= 0 ? '#00ff88' : '#ff4444'}">
                                        ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}
                                    </td>
                                    <td>
                                        <span class="status-badge ${pos.status.toLowerCase()}">
                                            ${pos.status}
                                        </span>
                                    </td>
                                    <td>
                                        ${!isClosed ? `
                                            <button class="btn-secondary btn" style="padding: 6px 12px; font-size: 12px;" 
                                                onclick="closePositionPrompt('${pos.id}')">
                                                Close
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        // Close position with prompt
        function closePositionPrompt(id) {
            const exitPrice = prompt('Enter exit price:');
            if (!exitPrice) return;
            
            try {
                PositionManager.closePosition(id, parseFloat(exitPrice), 'MANUAL');
                refreshPositions();
                updateStats();
                alert('‚úÖ Position closed');
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Update dashboard stats
        function updateStats() {
            const stats = PositionManager.getPortfolioStats();
            const signals = SignalScanner.cache.signals || [];
            
            document.getElementById('statOpenPositions').textContent = stats.openPositions;
            document.getElementById('statWinRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('statTotalPnL').textContent = '$' + stats.totalPnL.toFixed(2);
            document.getElementById('statTotalPnL').className = 'stat-value' + (stats.totalPnL < 0 ? ' negative' : '');
            document.getElementById('statActiveSignals').textContent = signals.length;
        }

        // View details (link to analysis page)
        function viewDetails(signal) {
            // Create modal with detailed signal information
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: #111;
                border: 1px solid #333;
                border-radius: 12px;
                padding: 30px;
                max-width: 800px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
            `;
            
            // Build trade details
            const trade = signal.trade || {};
            const strikes = trade.strikes || {};
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: #222;
                    border: none;
                    color: #fff;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 20px;
                ">&times;</button>
                
                <h2 style="color: #00ff88; margin-bottom: 20px;">${signal.symbol} - ${signal.strategy}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">ACTION</div>
                        <div style="font-size: 24px; font-weight: 700; color: ${signal.action === 'SELL' ? '#00ff88' : '#4a9eff'};">${signal.action}</div>
                    </div>
                    <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">CONFIDENCE</div>
                        <div style="font-size: 24px; font-weight: 700;">${signal.confidence}%</div>
                    </div>
                    <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">IV RANK</div>
                        <div style="font-size: 24px; font-weight: 700;">${signal.ivRank}%</div>
                    </div>
                    <div style="background: #0a0a0a; padding: 15px; border-radius: 8px; border: 1px solid #222;">
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">CURRENT IV</div>
                        <div style="font-size: 24px; font-weight: 700;">${(signal.currentIV > 100 ? signal.currentIV / 100 : signal.currentIV).toFixed(1)}%</div>
                    </div>
                </div>
                
                <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; border: 1px solid #222; margin-bottom: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px; font-size: 16px;">üìä Strategy Details</h3>
                    <p style="color: #aaa; line-height: 1.8;">${signal.reasoning}</p>
                </div>
                
                ${trade.type ? `
                <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; border: 1px solid #222; margin-bottom: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px; font-size: 16px;">üéØ Trade Specifications</h3>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222;">
                            <span style="color: #888;">Type:</span>
                            <span style="color: #fff; font-weight: 600;">${trade.type}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222;">
                            <span style="color: #888;">DTE:</span>
                            <span style="color: #fff; font-weight: 600;">${trade.dte || (trade.dte?.short ? `${trade.dte.short}/${trade.dte.long}` : 'N/A')} days</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222;">
                            <span style="color: #888;">Estimated Credit/Debit:</span>
                            <span style="color: #00ff88; font-weight: 600;">$${trade.estimatedCredit || trade.estimatedDebit || trade.estimatedPremium || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222;">
                            <span style="color: #888;">Max Profit:</span>
                            <span style="color: #00ff88; font-weight: 600;">$${trade.maxProfit || 'Unlimited'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222;">
                            <span style="color: #888;">Max Loss:</span>
                            <span style="color: #ff4444; font-weight: 600;">$${trade.maxLoss || 'Unlimited'}</span>
                        </div>
                        ${trade.pop ? `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222;">
                            <span style="color: #888;">Probability of Profit:</span>
                            <span style="color: #fff; font-weight: 600;">${trade.pop}%</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                ${Object.keys(strikes).length > 0 ? `
                <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; border: 1px solid #222; margin-bottom: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px; font-size: 16px;">üìç Strike Prices</h3>
                    <div style="display: grid; gap: 10px; font-family: monospace;">
                        ${Object.entries(strikes).map(([key, value]) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px; background: #000; border-radius: 4px;">
                                <span style="color: #888;">${key.replace(/([A-Z])/g, ' $1').trim()}:</span>
                                <span style="color: #00ff88; font-weight: 600;">$${value}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${signal.backtest ? `
                <div style="background: #0a0a0a; padding: 20px; border-radius: 8px; border: 1px solid #222; margin-bottom: 20px;">
                    <h3 style="color: #fff; margin-bottom: 15px; font-size: 16px;">üìà Backtest Performance</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Win Rate</div>
                            <div style="font-size: 20px; font-weight: 700; color: #00ff88;">${signal.backtest.winRate}%</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Trades</div>
                            <div style="font-size: 20px; font-weight: 700;">${signal.backtest.trades}</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 5px;">Sharpe Ratio</div>
                            <div style="font-size: 20px; font-weight: 700;">${signal.backtest.sharpe}</div>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                ${trade.note ? `
                <div style="background: #1a1a00; padding: 15px; border-radius: 8px; border: 1px solid #443300; margin-bottom: 20px;">
                    <div style="color: #ffaa00; font-size: 14px;">‚ö†Ô∏è ${trade.note}</div>
                </div>
                ` : ''}
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button onclick='openPosition(${JSON.stringify(signal)})' style="
                        flex: 1;
                        background: #00ff88;
                        color: #000;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                    ">Enter Trade</button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                        flex: 1;
                        background: #222;
                        color: #fff;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 8px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 16px;
                    ">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>
